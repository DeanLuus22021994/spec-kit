# Docker Registry Configuration
# Local registry for caching and serving container images
# Reference: https://docs.docker.com/registry/configuration/

version: 0.1

log:
  level: info
  formatter: text
  fields:
    service: registry
    environment: development

storage:
  # Local filesystem storage
  filesystem:
    rootdirectory: /var/lib/registry
    maxthreads: 100

  # Enable delete operations for garbage collection
  delete:
    enabled: true

  # Cache layer metadata in Redis
  cache:
    blobdescriptor: redis

  # Maintenance settings
  maintenance:
    uploadpurging:
      enabled: true
      age: 168h # 7 days
      interval: 24h
      dryrun: false
    readonly:
      enabled: false

# Redis for metadata caching
redis:
  addr: redis:6379
  db: 1
  pool:
    maxidle: 16
    maxactive: 64
    idletimeout: 300s

http:
  addr: :5000
  host: http://localhost:5000

  headers:
    X-Content-Type-Options: [nosniff]
    Access-Control-Allow-Origin: ["*"]
    Access-Control-Allow-Methods: ["HEAD", "GET", "OPTIONS", "DELETE"]
    Access-Control-Allow-Headers: ["Authorization", "Accept", "Cache-Control"]
    Access-Control-Max-Age: [1728000]
    Access-Control-Allow-Credentials: [true]
    Access-Control-Expose-Headers: ["Docker-Content-Digest"]

  # Enable debug endpoints
  debug:
    addr: :5001
    prometheus:
      enabled: true
      path: /metrics

  # TLS configuration (disabled for local development)
  # tls:
  #   certificate: /certs/domain.crt
  #   key: /certs/domain.key

# Health check configuration
health:
  storagedriver:
    enabled: true
    interval: 10s
    threshold: 3

# Proxy cache configuration for upstream registries
proxy:
  remoteurl: https://registry-1.docker.io
  username: ""
  password: ""

# Notifications (webhook for build events)
notifications:
  events:
    includereferences: true
  endpoints:
    - name: local-webhook
      disabled: true
      url: http://localhost:8080/registry/events
      headers:
        Authorization: [Bearer secret]
      timeout: 1s
      threshold: 10
      backoff: 1s
