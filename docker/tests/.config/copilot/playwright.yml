# Playwright Configuration Context
# Comprehensive reference for E2E test patterns, fixtures, and configuration

version: "1.0.0"
category: "playwright"
description: "Playwright test framework configuration and patterns"

playwright_config:
  location: "tests/playwright.config.ts"
  test_directory: "tests/e2e/"

  execution:
    parallel: true
    workers_ci: 1
    workers_dev: "undefined (automatic based on CPU)"
    retries_ci: 2
    retries_dev: 0

  reporters:
    html:
      output: "playwright-report/"
      open: "never"
      purpose: "Visual test results with screenshots"

    junit:
      output: "test-results/junit.xml"
      purpose: "CI/CD integration (Azure DevOps, Jenkins)"

    list:
      purpose: "Console output for debugging"

  timeouts:
    navigation: "30000ms (30s)"
    action: "15000ms (15s)"
    purpose: "Prevent hanging tests"

  capture:
    trace: "on-first-retry"
    screenshot: "only-on-failure"
    video: "retain-on-failure"

  base_url:
    default: "http://localhost:3000"
    docker: "http://frontend:3000"
    env_var: "BASE_URL"

test_structure:
  directories:
    e2e:
      path: "tests/e2e/"
      structure:
        api: "API integration tests"
        auth: "Authentication flows"
        frontend: "Frontend component tests"
        integration: "Full stack integration tests"

    pages:
      path: "tests/pages/"
      pattern: "Page Object Model (POM)"
      files:
        - "BasePage.ts - Base class with common methods"
        - "HomePage.ts - Home page interactions"
        - "LoginPage.ts - Login/auth page"
        - "DashboardPage.ts - Dashboard interactions"
        - "ApiHelper.ts - API request helpers"

    fixtures:
      path: "tests/fixtures/"
      purpose: "Test data and setup/teardown"
      files:
        - "testData.ts - Static test data"

    config:
      path: "tests/config/"
      files:
        - "environment.ts - Environment configuration"

    utils:
      path: "tests/utils/"
      files:
        - "helpers.ts - Common helper functions"
        - "matchers.ts - Custom Playwright matchers"

page_object_model:
  concept: "Encapsulate page interactions in classes"

  base_page:
    location: "tests/pages/BasePage.ts"
    features:
      - "Common navigation methods"
      - "Wait utilities"
      - "Screenshot helpers"
      - "Error handling"

  example_pattern:
    login_page:
      file: "tests/pages/LoginPage.ts"
      methods:
        - "goto() - Navigate to login page"
        - "login(username, password) - Perform login"
        - "isLoggedIn() - Verify authentication"
        - "getErrorMessage() - Retrieve error text"

  benefits:
    - "DRY (Don't Repeat Yourself)"
    - "Maintainable test code"
    - "Single source of truth for selectors"
    - "Easy to update when UI changes"

fixtures:
  playwright_fixtures:
    page: "Isolated browser page"
    context: "Isolated browser context"
    browser: "Browser instance"

  custom_fixtures:
    location: "tests/fixtures/testData.ts"
    purpose: "Shared test data and setup"

    example:
      test_users:
        valid_user:
          username: "testuser@example.com"
          password: "SecurePass123!"

        invalid_user:
          username: "invalid@example.com"
          password: "WrongPass"

      api_endpoints:
        health: "/health"
        login: "/api/auth/login"
        dashboard: "/api/dashboard"

  fixture_patterns:
    setup_teardown:
      before: "Seed test data, create test user"
      after: "Clean up test data, logout"

    data_isolation:
      strategy: "Each test gets fresh data"
      implementation: "Use beforeEach hook with fixtures"

test_patterns:
  authentication:
    location: "tests/e2e/auth/"
    patterns:
      - "Login with valid credentials"
      - "Login with invalid credentials"
      - "Logout and session management"
      - "Password reset flow"
      - "Navigate to sign-up page"

  api_testing:
    location: "tests/e2e/api/"
    helper: "tests/pages/ApiHelper.ts"
    patterns:
      - "GET requests with response validation"
      - "POST requests with payload"
      - "Authentication headers"
      - "Error response handling"

  frontend_testing:
    location: "tests/e2e/frontend/"
    patterns:
      - "Component rendering"
      - "User interactions (click, type, select)"
      - "Form validation"
      - "Navigation flows"

  integration_testing:
    location: "tests/e2e/integration/"
    patterns:
      - "Full user journey (login → action → logout)"
      - "Multi-page workflows"
      - "Data persistence across pages"

browser_projects:
  chromium:
    engine: "Blink (Google Chrome)"
    device: "Desktop Chrome"
    headless: true

  firefox:
    engine: "Gecko (Mozilla Firefox)"
    device: "Desktop Firefox"
    headless: true

  webkit:
    engine: "WebKit (Safari)"
    device: "Desktop Safari"
    headless: true

  mobile_chrome:
    engine: "Blink"
    device: "Pixel 5"
    viewport: "Mobile"

  mobile_safari:
    engine: "WebKit"
    device: "iPhone 12"
    viewport: "Mobile"

  benefits:
    - "Cross-browser compatibility testing"
    - "Mobile viewport validation"
    - "Parallel execution across browsers"

common_test_patterns:
  basic_test:
    structure: |
      import { test, expect } from '@playwright/test';
      import { HomePage } from '../pages/HomePage';

      test('should load home page', async ({ page }) => {
        const homePage = new HomePage(page);
        await homePage.goto();
        await expect(page).toHaveTitle(/Semantic Kernel/);
      });

  authenticated_test:
    structure: |
      test.describe('Authenticated tests', () => {
        test.beforeEach(async ({ page }) => {
          const loginPage = new LoginPage(page);
          await loginPage.login('user@example.com', 'password');
        });

        test('should access dashboard', async ({ page }) => {
          const dashboardPage = new DashboardPage(page);
          await dashboardPage.goto();
          await expect(dashboardPage.welcomeMessage).toBeVisible();
        });
      });

  api_test:
    structure: |
      test('should fetch user data', async ({ page }) => {
        const apiHelper = new ApiHelper(page);
        const response = await apiHelper.get('/api/user/123');
        expect(response.status).toBe(200);
        expect(response.data).toHaveProperty('username');
      });

environment_configuration:
  base_url:
    development: "http://localhost:3000"
    docker: "http://frontend:3000"
    ci: "process.env.BASE_URL"

  api_url:
    development: "http://localhost:5000"
    docker: "http://backend:80"
    ci: "process.env.API_URL"

  ci_mode:
    env_var: "CI"
    effects:
      - "forbidOnly: true (fail if test.only found)"
      - "retries: 2 (retry failed tests)"
      - "workers: 1 (sequential execution)"
      - "headless: true (no browser UI)"

test_execution:
  local_development:
    command: "npx playwright test"
    environment: "NODE_ENV=test"
    browsers: "All configured projects"

  single_browser:
    command: "npx playwright test --project=chromium"
    purpose: "Faster feedback for single browser"

  single_test:
    command: "npx playwright test tests/e2e/auth/login.spec.ts"
    purpose: "Debug specific test file"

  headed_mode:
    command: "npx playwright test --headed"
    purpose: "See browser UI during test"

  debug_mode:
    command: "npx playwright test --debug"
    purpose: "Step through test with inspector"

  ui_mode:
    command: "npx playwright test --ui"
    purpose: "Interactive test runner UI"

  docker_execution:
    command: "make test-docker"
    environment: "Isolated Docker network"
    services: "frontend, backend, database, vector, embeddings"

debugging:
  playwright_inspector:
    command: "npx playwright test --debug"
    features:
      - "Step through test execution"
      - "Inspect page elements"
      - "View network requests"
      - "Screenshot at each step"

  trace_viewer:
    command: "npx playwright show-trace trace.zip"
    captures:
      - "Screenshots at each action"
      - "Network activity"
      - "Console logs"
      - "DOM snapshots"

  codegen:
    command: "npx playwright codegen http://localhost:3000"
    purpose: "Record interactions and generate test code"

  screenshots:
    on_failure: "Automatic (screenshot: 'only-on-failure')"
    location: "test-results/<test-name>/<browser>/"
    format: "PNG"

  videos:
    on_failure: "Automatic (video: 'retain-on-failure')"
    location: "test-results/<test-name>/<browser>/"
    format: "WebM"

best_practices:
  selectors:
    prefer:
      - "data-testid attributes (reliable, semantic)"
      - "ARIA roles (accessible, semantic)"
      - "Text content (user-facing, but fragile)"

    avoid:
      - "CSS classes (styling changes break tests)"
      - "XPath (brittle, hard to maintain)"

  waits:
    use: "Playwright auto-waiting (built-in)"
    avoid: "page.waitForTimeout() (flaky)"

    explicit_waits:
      - "page.waitForSelector() - Element appears"
      - "page.waitForLoadState() - Page loaded"
      - "page.waitForResponse() - API response"

  assertions:
    use: "expect() with Playwright matchers"
    examples:
      - "expect(page).toHaveURL()"
      - "expect(locator).toBeVisible()"
      - "expect(locator).toHaveText()"
      - "expect(response).toBeOK()"

  test_isolation:
    principle: "Each test independent"
    implementation:
      - "beforeEach for setup"
      - "afterEach for cleanup"
      - "Avoid test.only (breaks CI)"
      - "No shared state between tests"

  page_objects:
    one_page_one_class: "HomePage.ts for home page"
    methods_return_pages: "login() returns DashboardPage"
    encapsulate_selectors: "No locators in test files"

performance:
  parallel_execution:
    enabled: true
    workers: "Auto-detected (CPU cores)"
    benefits: "Faster test suite completion"

  browser_reuse:
    context_per_test: "Isolated state"
    browser_shared: "Same browser instance"

  fixtures_optimization:
    lazy_loading: "Only create what's needed"
    cleanup: "Dispose after test"

troubleshooting:
  test_timeout:
    symptom: "Test exceeded timeout"
    solutions:
      - "Increase navigationTimeout or actionTimeout"
      - "Check for infinite loops"
      - "Verify services are healthy"

  selector_not_found:
    symptom: "Locator not found"
    solutions:
      - "Use Playwright Inspector to verify selector"
      - "Check element is visible"
      - "Wait for element to appear"

  flaky_tests:
    symptom: "Test passes sometimes, fails sometimes"
    solutions:
      - "Avoid hard-coded waits (waitForTimeout)"
      - "Use explicit waits (waitForSelector)"
      - "Check for race conditions"
      - "Ensure test isolation"

  screenshot_missing:
    symptom: "No screenshot on failure"
    solutions:
      - "Verify screenshot: 'only-on-failure' in config"
      - "Check test-results/ directory exists"
      - "Ensure sufficient disk space"

migration_notes:
  from: "tests/ (flat structure)"
  to: "tests/.config/ (organized structure)"
  changes:
    - "Docker files moved to tests/.config/docker/"
    - "Scripts moved to tests/.config/scripts/"
    - "Documentation moved to tests/.config/documentation/"
  benefits:
    - "Clearer separation of concerns"
    - "Easier navigation"
    - "Pattern alignment with root .config/"
