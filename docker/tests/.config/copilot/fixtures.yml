# Fixtures Configuration Context
# Reference for test data, fixtures, and test environment setup

version: "1.0.0"
category: "fixtures"
description: "Test data patterns, fixtures, and environment configuration"

test_data_structure:
  location: "tests/fixtures/testData.ts"

  purpose: "Centralized test data for consistent testing"

  categories:
    users:
      valid_user:
        username: "testuser@example.com"
        password: "SecurePass123!"
        role: "user"

      admin_user:
        username: "admin@example.com"
        password: "AdminPass456!"
        role: "admin"

      invalid_user:
        username: "invalid@example.com"
        password: "WrongPassword"
        purpose: "Negative testing"

    api_endpoints:
      health: "/health"
      auth:
        login: "/api/auth/login"
        logout: "/api/auth/logout"
        register: "/api/auth/register"

      user:
        profile: "/api/user/profile"
        settings: "/api/user/settings"

      semantic:
        query: "/api/semantic/query"
        embeddings: "/api/semantic/embeddings"

    ui_selectors:
      login_form:
        username_input: '[data-testid="username-input"]'
        password_input: '[data-testid="password-input"]'
        submit_button: '[data-testid="login-button"]'
        error_message: '[data-testid="error-message"]'

      dashboard:
        welcome_message: '[data-testid="welcome-message"]'
        user_menu: '[data-testid="user-menu"]'
        logout_link: '[data-testid="logout-link"]'

fixture_patterns:
  playwright_fixtures:
    built_in:
      page:
        description: "Isolated browser page instance"
        scope: "test"
        lifecycle: "Created before each test, destroyed after"

      context:
        description: "Browser context (cookies, storage)"
        scope: "test"
        isolation: "Complete isolation between tests"

      browser:
        description: "Browser instance (Chromium, Firefox, WebKit)"
        scope: "worker"
        reuse: "Shared across tests in same worker"

      request:
        description: "API request context"
        scope: "test"
        usage: "API testing without browser"

  custom_fixtures:
    authenticated_page:
      purpose: "Pre-authenticated browser page"
      implementation: |
        import { test as base } from '@playwright/test';

        export const test = base.extend({
          authenticatedPage: async ({ page }, use) => {
            // Login before test
            await page.goto('/login');
            await page.fill('[data-testid="username"]', 'testuser@example.com');
            await page.fill('[data-testid="password"]', 'SecurePass123!');
            await page.click('[data-testid="login-button"]');
            await page.waitForURL('/dashboard');

            await use(page);

            // Logout after test
            await page.click('[data-testid="logout"]');
          },
        });

      usage: |
        test('authenticated test', async ({ authenticatedPage }) => {
          // Test runs with authenticated page
          await expect(authenticatedPage).toHaveURL('/dashboard');
        });

    api_context:
      purpose: "Pre-configured API request context"
      implementation: |
        export const test = base.extend({
          apiContext: async ({ request }, use) => {
            const token = await getAuthToken();
            const apiRequest = await request.newContext({
              baseURL: 'http://backend:80',
              extraHTTPHeaders: {
                'Authorization': `Bearer ${token}`,
              },
            });

            await use(apiRequest);
            await apiRequest.dispose();
          },
        });

environment_config:
  location: "tests/config/environment.ts"

  configuration:
    development:
      base_url: "http://localhost:3000"
      api_url: "http://localhost:5000"
      database_url: "postgres://user:password@localhost:5432/semantic_kernel_dev"

    docker:
      base_url: "http://frontend:3000"
      api_url: "http://backend:80"
      database_url: "postgres://user:test_password@database:5432/semantic_kernel_test"

    ci:
      base_url: "process.env.BASE_URL"
      api_url: "process.env.API_URL"
      database_url: "process.env.DATABASE_URL"

  usage:
    import: "import { config } from './config/environment';"
    access: "config.baseURL"

data_seeding:
  script: "tests/.config/scripts/seed-test-data.sh"

  purpose: "Populate test database with initial data"

  data_types:
    users:
      - "Test user accounts with various roles"
      - "Admin accounts for privileged operations"

    documents:
      - "Sample documents for search testing"
      - "Test embeddings for vector search"

    configurations:
      - "System settings"
      - "Feature flags"

  when_to_seed:
    - "Before integration test suite"
    - "After database migration"
    - "When test data corrupted"

  cleanup:
    strategy: "Truncate tables after test suite"
    script: "Integrated in cleanup.sh"

test_isolation:
  principle: "Each test runs in complete isolation"

  implementations:
    database:
      strategy: "Transactions (rollback after each test)"
      alternative: "Truncate tables (slower)"

    browser:
      strategy: "Fresh browser context per test"
      playwright: "Automatic isolation"

    storage:
      strategy: "Clear cookies and localStorage"
      hook: "beforeEach"

    api_state:
      strategy: "Reset API state (clear cache, sessions)"
      implementation: "Call cleanup endpoint"

fixture_organization:
  structure:
    fixtures:
      directory: "tests/fixtures/"
      files:
        testData.ts: "Static test data (users, endpoints, selectors)"
        authFixtures.ts: "Authentication-related fixtures"
        apiFixtures.ts: "API testing fixtures"

    config:
      directory: "tests/config/"
      files:
        environment.ts: "Environment-specific configuration"

  imports:
    pattern: |
      // In test files
      import { testUsers, apiEndpoints } from '../fixtures/testData';
      import { test } from '../fixtures/authFixtures';

best_practices:
  test_data:
    centralized: "Keep all test data in fixtures/"
    typed: "Use TypeScript for type safety"
    realistic: "Use realistic data (emails, names, etc.)"
    avoid_hardcoding: "Import from fixtures, don't hardcode in tests"

  fixtures:
    single_responsibility: "Each fixture does one thing"
    cleanup: "Always cleanup after use"
    scope: "Use appropriate scope (test vs worker)"

  environment:
    env_vars: "Use environment variables for URLs"
    defaults: "Provide sensible defaults"
    validation: "Validate required config exists"

  data_seeding:
    idempotent: "Can run multiple times safely"
    fast: "Minimize data insertion"
    cleanup: "Always cleanup seeded data"

common_patterns:
  setup_teardown:
    before_each: |
      test.beforeEach(async ({ page }) => {
        // Seed data
        await seedTestData();
        // Navigate to page
        await page.goto('/');
      });

    after_each: |
      test.afterEach(async ({ page }) => {
        // Cleanup test data
        await cleanupTestData();
        // Close page
        await page.close();
      });

  conditional_fixtures:
    pattern: |
      const test = base.extend({
        conditionalPage: async ({ page }, use, testInfo) => {
          if (testInfo.project.name === 'chromium') {
            // Chromium-specific setup
          }
          await use(page);
        },
      });

  parameterized_tests:
    pattern: |
      const users = [
        { username: 'user1@example.com', expected: 'User Dashboard' },
        { username: 'admin@example.com', expected: 'Admin Dashboard' },
      ];

      for (const user of users) {
        test(`login as ${user.username}`, async ({ page }) => {
          await loginPage.login(user.username, 'password');
          await expect(page).toHaveTitle(user.expected);
        });
      }

api_testing_fixtures:
  request_context:
    purpose: "Make API calls without browser"
    example: |
      test('API test', async ({ request }) => {
        const response = await request.get('/api/health');
        expect(response.status()).toBe(200);
      });

  authenticated_api:
    purpose: "API calls with authentication"
    example: |
      const apiContext = await request.newContext({
        baseURL: 'http://backend:80',
        extraHTTPHeaders: {
          'Authorization': 'Bearer <token>',
        },
      });

mocking:
  api_responses:
    purpose: "Mock backend responses"
    example: |
      await page.route('/api/user/*', route => {
        route.fulfill({
          status: 200,
          body: JSON.stringify({ username: 'testuser' }),
        });
      });

  feature_flags:
    purpose: "Test different feature configurations"
    example: |
      await page.addInitScript(() => {
        window.featureFlags = { newUI: true };
      });

troubleshooting:
  fixture_not_found:
    symptom: "Cannot find module '../fixtures/testData'"
    solution: "Check import path, ensure file exists"

  data_isolation_fail:
    symptom: "Tests interfere with each other"
    solutions:
      - "Ensure fresh browser context per test"
      - "Clear database between tests"
      - "Check for shared state"

  seeding_slow:
    symptom: "Test suite slow due to seeding"
    solutions:
      - "Seed only required data"
      - "Use transactions instead of full cleanup"
      - "Cache seeded data across tests"

  environment_mismatch:
    symptom: "Tests fail in different environments"
    solutions:
      - "Use environment.ts for config"
      - "Validate environment variables"
      - "Check service URLs"

migration_notes:
  from: "tests/fixtures/ (flat structure)"
  to: "tests/fixtures/ (organized with .config/ pattern)"

  benefits:
    - "Clear separation of fixtures from configuration"
    - "Easier to locate test data files"
    - "Consistent with .config/ pattern"

  maintained:
    - "tests/fixtures/testData.ts (test data)"
    - "tests/config/environment.ts (env config)"

  new_in_config:
    - "tests/.config/scripts/seed-test-data.sh (seeding)"
    - "tests/.config/copilot/fixtures.yml (this file)"
