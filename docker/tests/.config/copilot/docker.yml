# Docker Configuration Context
# Comprehensive reference for test container setup, baked dependencies, and Docker Compose orchestration

version: "1.0.0"
category: "docker"
description: "Docker containerization patterns for test infrastructure"

dockerfile_structure:
  location: "tests/.config/docker/Dockerfile"
  base_image: "mcr.microsoft.com/playwright:v1.40.0-jammy"
  pattern: "Baked dependencies (zero runtime installation)"

  stages:
    base:
      purpose: "Production-ready test container"
      features:
        - "Baked npm packages (@playwright/test, @types/node, typescript)"
        - "Preinstalled Playwright browsers (chromium, firefox, webkit)"
        - "Non-root user (testsuser:1001)"
        - "Health check validation"
        - "Named volume cache directories"

    dev:
      purpose: "Development and debugging"
      features:
        - "Additional dev tools (nodemon)"
        - "Playwright UI mode"
        - "CI=false for interactive debugging"

    ci:
      purpose: "CI/CD optimized"
      features:
        - "Multiple reporters (HTML, JUnit)"
        - "CI=true for headless execution"
        - "Optimized for parallel execution"

baked_dependencies:
  concept: "Install all npm packages at build time, not runtime"
  benefits:
    - "Zero npm install latency (30-60s eliminated)"
    - "Consistent dependency versions"
    - "Faster container startup (0s dependency installation)"
    - "Reproducible builds"

  packages:
    playwright_test:
      package: "@playwright/test"
      version: "1.40.0"
      purpose: "Test framework and runner"

    types_node:
      package: "@types/node"
      version: "24.10.1"
      purpose: "TypeScript type definitions for Node.js"

    typescript:
      package: "typescript"
      version: "5.3.0"
      purpose: "TypeScript compiler"

  installation:
    command: "RUN npm install -g --no-cache"
    flags:
      global: "Install globally for all users"
      no_cache: "Skip npm cache to reduce image size"

  browsers:
    command: "RUN npx playwright install --with-deps chromium firefox webkit"
    size: "~1.5GB"
    included:
      - "Chromium (Google Chrome engine)"
      - "Firefox (Mozilla engine)"
      - "WebKit (Safari engine)"
    system_deps: "Installed via --with-deps flag"

named_volumes:
  strategy: "Persistent caches survive container rebuilds"

  volumes:
    playwright_cache:
      name: "playwright-cache"
      mount: "/app/tests/.playwright-cache"
      purpose: "Browser binaries cache"
      size: "~1.5GB"
      persistence: "Survives docker-compose down (without -v)"

    npm_cache:
      name: "npm-cache"
      mount: "/app/tests/.npm"
      purpose: "npm package cache"
      persistence: "Survives rebuilds"

    test_artifacts:
      name: "test-artifacts"
      mount: "/app/tests/test-results"
      purpose: "JUnit XML and test results"
      extraction: "Use make test-extract-results"

    test_reports:
      name: "test-reports"
      mount: "/app/tests/playwright-report"
      purpose: "HTML test reports"
      extraction: "Use make test-extract-results"

  benefits:
    - "Caches survive container rebuilds"
    - "Faster subsequent builds (reuse browser binaries)"
    - "Isolated from host filesystem"
    - "Easy extraction with docker cp"

health_checks:
  dockerfile:
    interval: "30s"
    timeout: "3s"
    start_period: "5s"
    retries: 3
    command: "node --version && npx playwright --version"
    purpose: "Validate Node.js and Playwright installation"

  docker_compose:
    database:
      test: "pg_isready -U user -d semantic_kernel_test"
      interval: "5s"

    vector:
      test: "curl -f http://localhost:6333/healthz"
      interval: "5s"

    backend:
      test: "curl -f http://localhost:80/health"
      interval: "5s"

    frontend:
      test: "curl -f http://localhost:3000"
      interval: "5s"

multi_stage_builds:
  purpose: "Optimize for different environments"

  targets:
    base:
      use_case: "Default production build"
      command: "docker build --target base"

    dev:
      use_case: "Local development with UI"
      command: "docker build --target dev"

    ci:
      use_case: "CI/CD with multiple reporters"
      command: "docker build --target ci"

  benefits:
    - "Single Dockerfile for all environments"
    - "Reduced image size for production"
    - "Development tools isolated to dev stage"

docker_compose_services:
  location: "tests/.config/docker/docker-compose.test.yml"

  services:
    database:
      image: "postgres:16-alpine"
      storage: "tmpfs (in-memory for speed)"
      purpose: "Test database isolation"

    vector:
      image: "qdrant/qdrant:v1.7.4"
      storage: "tmpfs (in-memory for speed)"
      purpose: "Vector store for embeddings"

    embeddings:
      build: "../dockerfiles/embeddings.Dockerfile"
      purpose: "OpenAI embeddings service"

    backend:
      build: "../dockerfiles/backend.Dockerfile"
      purpose: ".NET 8 Web API"

    frontend:
      build: "../dockerfiles/frontend.Dockerfile"
      purpose: "React + TypeScript SPA"

    tests:
      build: "tests/.config/docker/Dockerfile"
      target: "ci"
      depends_on: "All services healthy"
      command: "/app/tests/.config/scripts/run-tests.sh"

  networks:
    test_network:
      driver: "bridge"
      purpose: "Isolate test services"

dockerignore:
  location: "tests/.config/docker/.dockerignore"

  excluded:
    build_artifacts:
      - "node_modules/"
      - "playwright-report/"
      - "test-results/"
      - "*.log"

    package_files:
      - "package-lock.json (dependencies baked in)"

    cache_directories:
      - ".playwright-cache/"
      - "playwright/.cache/"

    development:
      - ".env.local"
      - ".vscode/"
      - ".idea/"

  purpose: "Reduce build context size (~500MB â†’ ~50MB)"

security:
  non_root_user:
    username: "testsuser"
    uid: 1001
    gid: "testsuser"
    creation:
      - "groupadd -r testsuser"
      - "useradd -r -g testsuser -u 1001 testsuser"

  permissions:
    cache_directories:
      command: "chown -R testsuser:testsuser /app/tests"
      directories:
        - "/app/tests/.playwright-cache"
        - "/app/tests/.npm"
        - "/app/tests/playwright-report"
        - "/app/tests/test-results"
        - "/app/tests/node_modules"

  benefits:
    - "Follows least privilege principle"
    - "Matches pattern with tools/toolsuser:1001"
    - "Prevents accidental host filesystem modification"

environment_variables:
  ci:
    var: "CI"
    value: "true"
    purpose: "Enable CI mode (headless browsers)"

  node_env:
    var: "NODE_ENV"
    value: "test"
    purpose: "Test environment configuration"

  playwright_browsers:
    var: "PLAYWRIGHT_BROWSERS_PATH"
    value: "/ms-playwright"
    purpose: "Browser binary location"

  node_options:
    var: "NODE_OPTIONS"
    value: "--max-old-space-size=4096"
    purpose: "Increase Node.js memory limit"

  runtime_vars:
    BASE_URL: "http://frontend:3000"
    API_URL: "http://backend:80"

common_workflows:
  build:
    command: "docker build -f tests/.config/docker/Dockerfile -t semantic-kernel-tests:latest ."
    context: "tests/"
    target: "ci (default: base)"

  run:
    command: "docker-compose -f tests/.config/docker/docker-compose.test.yml up --abort-on-container-exit"
    flags:
      abort_on_container_exit: "Stop all services when tests complete"

  rebuild_cache:
    command: "docker-compose down -v && docker-compose build --no-cache"
    when: "package.json changes or dependency updates"

  extract_results:
    reports: "docker cp <container>:/app/tests/playwright-report ./playwright-report"
    artifacts: "docker cp <container>:/app/tests/test-results ./test-results"

pattern_alignment:
  with: "tools/Dockerfile"
  shared_patterns:
    - "Baked dependencies (pip for tools, npm for tests)"
    - "Non-root user (toolsuser:1001, testsuser:1001)"
    - "Health checks for validation"
    - "Multi-stage builds (base, dev, ci)"
    - "Named volumes for persistent caches"

  consistency:
    percentage: "100%"
    benefits:
      - "Predictable container behavior"
      - "Same optimization patterns"
      - "Easy to understand and maintain"

troubleshooting:
  build_failures:
    npm_install:
      symptom: "npm install -g fails"
      solution: "Check npm registry availability, verify package versions"

    playwright_install:
      symptom: "npx playwright install fails"
      solution: "Ensure --with-deps includes system dependencies, check disk space"

  runtime_issues:
    health_check_fails:
      symptom: "Container marked unhealthy"
      solution: "Check node --version && npx playwright --version output"

    volume_permissions:
      symptom: "Permission denied writing to volumes"
      solution: "Verify chown -R testsuser:testsuser commands executed"

  cache_management:
    lost_volumes:
      symptom: "Caches disappear after cleanup"
      solution: "Use docker-compose down without -v flag"

    outdated_cache:
      symptom: "Old dependencies after package.json update"
      solution: "Run make test-rebuild-cache to force rebuild"

migration_from_runtime_install:
  before:
    pattern: "COPY package.json + RUN npm ci at runtime"
    latency: "30-60s npm install per container start"

  after:
    pattern: "RUN npm install -g at build time"
    latency: "0s (dependencies baked in)"

  benefits:
    - "100% elimination of npm install latency"
    - "Consistent dependency versions"
    - "Faster test execution"
    - "Better CI/CD pipeline performance"
