version: "3.8"

services:
  # Test database (tmpfs for speed)
  database:
    image: postgres:16-alpine
    environment:
      POSTGRES_DB: semantic_kernel_test
      POSTGRES_USER: user
      POSTGRES_PASSWORD: test_password
    tmpfs:
      - /var/lib/postgresql/data
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U user -d semantic_kernel_test"]
      interval: 5s
      timeout: 3s
      retries: 10
    networks:
      - test-network

  # Test vector store (tmpfs for speed)
  vector:
    image: qdrant/qdrant:v1.7.4
    tmpfs:
      - /qdrant/storage
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:6333/healthz"]
      interval: 5s
      timeout: 3s
      retries: 10
    networks:
      - test-network

  # Embeddings service
  embeddings:
    build:
      context: ..
      dockerfile: dockerfiles/embeddings.Dockerfile
    depends_on:
      database:
        condition: service_healthy
    environment:
      DATABASE_URL: postgres://user:test_password@database:5432/semantic_kernel_test
      OPENAI_API_KEY: ${OPENAI_API_KEY:-test_key}
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8001/health"]
      interval: 5s
      timeout: 3s
      retries: 10
    networks:
      - test-network

  # Backend service
  backend:
    build:
      context: ..
      dockerfile: dockerfiles/backend.Dockerfile
    depends_on:
      database:
        condition: service_healthy
      vector:
        condition: service_healthy
      embeddings:
        condition: service_healthy
    environment:
      ConnectionStrings__DefaultConnection: "Host=database;Port=5432;Database=semantic_kernel_test;Username=user;Password=test_password"
      VectorStore__Url: "http://vector:6333"
      Embeddings__Url: "http://embeddings:8001"
      ASPNETCORE_ENVIRONMENT: Test
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:80/health"]
      interval: 5s
      timeout: 3s
      retries: 10
    networks:
      - test-network

  # Frontend service
  frontend:
    build:
      context: ..
      dockerfile: dockerfiles/frontend.Dockerfile
    depends_on:
      backend:
        condition: service_healthy
    environment:
      REACT_APP_API_URL: http://backend:80
      NODE_ENV: test
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:3000"]
      interval: 5s
      timeout: 3s
      retries: 10
    networks:
      - test-network

  # Tests container (aligned with tools pattern)
  tests:
    build:
      context: ../..
      dockerfile: .config/docker/Dockerfile
      target: ci
    depends_on:
      frontend:
        condition: service_healthy
      backend:
        condition: service_healthy
    volumes:
      - playwright-cache:/app/tests/.playwright-cache
      - npm-cache:/app/tests/.npm
      - test-artifacts:/app/tests/test-results
      - test-reports:/app/tests/playwright-report
    environment:
      CI: "true"
      BASE_URL: http://frontend:3000
      API_URL: http://backend:80
    networks:
      - test-network
    command: /app/tests/.config/scripts/run-tests.sh

networks:
  test-network:
    driver: bridge

volumes:
  playwright-cache:
    driver: local
  npm-cache:
    driver: local
  test-artifacts:
    driver: local
  test-reports:
    driver: local
